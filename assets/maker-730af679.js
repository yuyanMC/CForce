import{v as S,a as Z,b as q}from"./runtime-dom.esm-bundler-ac0a114c.js";import X from"./hit-556a07c1.js";import{EnhancedContent as ee,TextCanvasObject as ae,RGBAColor as n,NoteCanvasObject as T,ClackLineCanvasObject as te}from"./gui-d002ad5e.js";import{EventBus as le}from"./event-4329e05e.js";import{Chart as M}from"./chart-314b5cd1.js";import{DynamicLoader as R}from"./network-222e4f3b.js";import{EnhancedAudioContext as se,SoundManager as ne}from"./sound-442b705b.js";import{s as oe,t as v,u as ie,C as P,v as U,w as t,F as ue,D as ce,E as A,y as re,G as de,B as E,x as pe,H as he,I as fe,_ as ve}from"./_plugin-vue_export-helper-79bc846b.js";import"./util-720ff2c1.js";const o=x=>(he("data-v-b4f75997"),x=x(),fe(),x),_e={id:"innerBox"},me=o(()=>t("canvas",{id:"main_canvas",width:"3200",height:"1800"},null,-1)),we=[me],ge={id:"notes"},be={class:"showNote"},Ae=["fill"],xe=o(()=>t("circle",{r:"2em",cx:"2.5em",cy:"2.5em",fill:"#00000000",stroke:"white","stroke-width":"0.05em"},null,-1)),ke={class:"noteTag"},ye=o(()=>t("span",{class:"noteTrack"},"Track",-1)),Ce=["onUpdate:modelValue"],Be=o(()=>t("option",{value:"A"},"A",-1)),Te=o(()=>t("option",{value:"B"},"B",-1)),Ue=[Be,Te],Ee=o(()=>t("span",{class:"noteHitTime"},"Hit Time",-1)),Ie=["onUpdate:modelValue"],Se={id:"dataBox"},Me=o(()=>t("span",null,"Sec: ",-1)),Ve=o(()=>t("br",null,null,-1)),$e=o(()=>t("span",null,"Paused: ",-1)),De=o(()=>t("br",null,null,-1)),Ne=o(()=>t("span",null,"Chart: ",-1)),Fe=o(()=>t("br",null,null,-1)),Le=o(()=>t("span",null,"Upload Music: ",-1)),Oe=o(()=>t("br",null,null,-1)),Re=o(()=>t("span",null,"Upload Background: ",-1)),Pe=o(()=>t("br",null,null,-1)),je=oe({__name:"maker",setup(x){let j=new R("images"),V=new R("sounds"),g;const d=v(new M({notes:[],animationNotes:[],bgsound:"maker.mp3",length:3600}));let c=60,k,r=new se(new AudioContext),G=.5,H=.5,_=0,m=!1,y=[];const b=v(0),s=v(0);let C=0,i,f=new le,w=v({notes:[],animationNotes:[],bgsound:"maker.mp3",length:3600});const $=v(null),D=v(null),J=v(null),N=v(null);function h(e,a,l,p="left",u=50,I=new n(255,255,255)){i.render(new ae(e,a,l,p,u,I instanceof n?I:new n(255,255,255,I)))}function F(e){if(e.a||(s.value-e.h+e.p.spd)/e.p.spd<0||(s.value-e.h+e.p.spd)/e.p.spd>1)return;let a=e.p.cal((s.value-e.h+e.p.spd)/e.p.spd),l=new n(e.f[0],e.f[1],e.f[2]);i.render(new T(...a,l))}function Q(e){e.y=="A"&&((s.value-e.h+e.p.spd)/e.p.spd<0||(s.value-e.al-e.h+e.p.spd)/e.p.spd>1||i.render(new te(e.p,(s.value-e.al-e.h+e.p.spd)/e.p.spd,(s.value-e.h+e.p.spd)/e.p.spd)))}function L(e){if(e.a<=0)return;let a=s.value-e.aa,l=e.p.cal((e.aa-e.h+e.p.spd)/e.p.spd);if(e.a==12&&a<e.hi){let p=a/e.hi+1,u=new n(e.f[0],e.f[1],e.f[2],p-1);i.render(new T(...l,u))}else if(e.a==11&&a<e.ho){let p=a/e.ho+1,u=new n(e.f[0],e.f[1],e.f[2],2-p);i.render(new T(...l,u))}else if(e.a>0&&a<.25){let p=a/.25+1,u=new n(0,0,0,0);e.a==1?u=new n(160,144,0,2-p):e.a==2&&(u=new n(0,167,195,2-p)),i.render(new T(...l,u,p*88))}}function K(){g.fillStyle="rgb(255,255,255)",g.font="50px 'Courier New'",g.textAlign="center",h(`${_}`,1600,60,"center"),h("COMBO",1600,120,"center"),h(`Point: ${(_/d.value.notesTotal*1e5).toFixed(0)}`,3150,60,"right"),h(`Music: ${(s.value/d.value.length*100).toFixed(2)}%`,3150,120,"right");{let e=y.length,a=new n(255,0,255);e/c>=0&&(a=new n(255,0,255)),e/c>.3&&(a=new n(255,0,63)),e/c>.6&&(a=new n(255,0,0)),e/c>.9&&(a=new n(255,127,0)),e/c>.95&&(a=new n(255,255,0)),e/c>.999&&(a=new n(0,255,0)),e/c>.99999&&(a=new n(0,255,255)),h(`TPS: ${e.toFixed(0)}/${c}`,3150,180,"right",50,a),h(`Sec: ${s.value.toFixed(3)} Paused: ${C.toFixed(3)} Total: ${((Date.now()-b.value)/1e3).toFixed(3)} Music: ${r.actx.currentTime.toFixed(3)}`,3150,240,"right")}}function Y(){i.clear()}ie(async()=>{document.getElementById("canvas_box").style.backgroundImage=`url(${await j.loadAsUrl("maker.png").catch(()=>"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2P4DwQACfsD/Z8fLAAAAAAASUVORK5CYII=")})`,g=document.getElementById("main_canvas").getContext("2d"),i=new ee(g),i.setBackGroundColor("rgba(0,0,0,0.5)"),i.clear(),h("游戏正在加载",1600,900,"center",200,new n(200,200,200)),f.on("hit",()=>{_++}),f.on("hit",()=>{k.play()}),f.on("tick",()=>{let a=Date.now();for(y.push(a);a-y[0]>=1e3;)y.splice(0,1)}),f.on("start",()=>{b.value=Date.now()-r.actx.currentTime*1e3}),i.clear(),h("点击屏幕开始",1600,900,"center",200,new n(230,230,230)),await new Promise(a=>{document.getElementById("main_canvas").onclick=()=>{document.getElementById("main_canvas").onclick=null,a(null)}}),i.clear(),h("加载中",1600,900,"center",200,new n(250,250,250)),k=new ne(X),await r.actx.suspend(),await k.load(),await r.load(await V.loadAsUrl(w.value.bgsound)),r.setVolume(H),k.setVolume(G),f.on("start",()=>{setInterval(async function(){if(m){C=(Date.now()-b.value)/1e3-s.value;return}Y(),s.value=(Date.now()-b.value)/1e3-C,f.emit("tick",s.value),d.value.animationNotes.forEach(a=>{a.a==12&&s.value-a.aa>a.hi?(a.a=0,a.aa=0):Math.abs(a.h-s.value)<=1.5/c?a.ho&&(a.a=11,a.aa=s.value):a.hi!=null&&Math.abs(a.h-a.p.spd-a.hi-s.value)<=1.5/c&&(a.a=12,a.aa=s.value),F(a),L(a)}),d.value.notes.forEach(a=>{Q(a)}),d.value.notes.forEach(a=>{!a.a&&Math.abs(a.h-s.value)<1.5/c?(a.a=1,a.aa=a.h,f.emit("hit",1)):s.value-a.h>.16&&!a.a&&(a.a=-1,f.emit("miss",null)),F(a)}),d.value.notes.forEach(a=>{L(a)}),K(),s.value>=w.value.length&&(B.value=0)},1e3/c)}),i.clear(),await r.actx.resume(),r.play(0),f.emit("start",null)});const B=P({get:()=>s.value,set:e=>{d.value=new M(w.value),_=0,d.value.notes.forEach(a=>{a.h<e&&_++}),r.pause(),b.value=Date.now()-e*1e3,C=0,r.play(e)}}),O=P({get:()=>JSON.stringify(w.value),set:async e=>{let a;try{a=JSON.parse(e)}catch(l){console.error(l);return}d.value=new M(a),_=0,d.value.notes.forEach(l=>{l.h<s.value&&_++});try{r.pause()}catch(l){console.error(l)}a.bgsound!=w.value.bgsound&&(m=!0,i.clear(),h("加载中",1600,900,"center",200,new n(250,250,250)),await r.load(await V.loadAsUrl(a.bgsound)),i.clear()),w.value=a,B.value=0}});function z(){let e=URL.createObjectURL(D.value.files[0]);console.log(e),N.value.style.backgroundImage=`url(${e})`}function W(){let e=URL.createObjectURL($.value.files[0]);console.log(e),r.load(e)}return(e,a)=>(E(),U("div",{id:"gameBox",ref_key:"gamebox",ref:J},[t("div",_e,[t("div",{id:"canvas_box",ref_key:"canvasbox",ref:N},we,512),t("ul",ge,[(E(!0),U(ue,null,ce(d.value.notes,(l,p)=>(E(),U("li",null,[(E(),U("svg",be,[t("circle",{r:"2.2em",cx:"2.5em",cy:"2.5em",fill:`rgb(${l.f[0]},${l.f[1]},${l.f[2]})`,"stroke-width":"0"},null,8,Ae),xe])),t("span",ke,"Note #"+pe(p),1),ye,A(t("select",{class:"noteTrackInput","onUpdate:modelValue":u=>l.t=u},Ue,8,Ce),[[q,l.t]]),Ee,A(t("input",{class:"noteHitTimeInput","onUpdate:modelValue":u=>l.h=u,type:"number"},null,8,Ie),[[S,l.h]])]))),256))]),t("div",Se,[Me,A(t("input",{"onUpdate:modelValue":a[0]||(a[0]=l=>B.value=l)},null,512),[[S,B.value,void 0,{lazy:!0}]]),Ve,$e,A(t("input",{id:"pause",type:"checkbox","onUpdate:modelValue":a[1]||(a[1]=l=>de(m)?m.value=l:m=l)},null,512),[[Z,re(m)]]),De,Ne,A(t("input",{"onUpdate:modelValue":a[2]||(a[2]=l=>O.value=l)},null,512),[[S,O.value]]),Fe,Le,t("input",{type:"file",accept:"audio/*",ref_key:"music",ref:$,onChange:W},null,544),Oe,Re,t("input",{type:"file",accept:"image/*",ref_key:"bg",ref:D,onChange:z},null,544),Pe])])],512))}});const qe=ve(je,[["__scopeId","data-v-b4f75997"]]);export{qe as default};
