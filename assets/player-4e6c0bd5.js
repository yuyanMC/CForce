var Y=Object.defineProperty;var H=(i,t,s)=>t in i?Y(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s;var o=(i,t,s)=>(H(i,typeof t!="symbol"?t+"":t,s),s);import{_ as c}from"./preload-helper-8235fac6.js";import{calculateAngle as B,getQueryString as X}from"./util-159a5f05.js";const z="/assets/hit-7d4160ed.mp3",Z=Object.freeze(Object.defineProperty({__proto__:null,default:z},Symbol.toStringTag,{value:"Module"})),F="/assets/blank-d6053d36.mp3",tt=Object.freeze(Object.defineProperty({__proto__:null,default:F},Symbol.toStringTag,{value:"Module"}));class U{constructor(t){o(this,"ctx");o(this,"backGroundColor","rgba(0,0,0,0)");o(this,"size",[300,150]);this.ctx=t,this.size=[parseInt(this.ctx.canvas.getAttribute("width")||"300"),parseInt(this.ctx.canvas.getAttribute("height")||"150")]}setBackGroundColor(t){this.backGroundColor=t}clear(){this.ctx.fillStyle=this.backGroundColor,this.ctx.clearRect(0,0,...this.size),this.ctx.fillRect(0,0,...this.size)}render(t){t.drawOnCtx(this.ctx)}}class st{}class v{constructor(t=-100,s=-100,r=new h(64,64,64),e=88){o(this,"x",-100);o(this,"y",-100);o(this,"f",new h(64,64,64));o(this,"r",88);this.x=t,this.y=s,this.f=r,this.r=e}drawOnCtx(t){t.fillStyle=`rgba(${this.f.getColor()[0]},${this.f.getColor()[1]},${this.f.getColor()[2]},${this.f.getColor()[3]})`,t.beginPath(),t.arc(this.x,this.y,this.r,0,Math.PI*2,!0),t.fill(),t.lineWidth=2,t.strokeStyle=`rgba(255,255,255,${this.f.getColor()[3]})`,t.beginPath(),t.arc(this.x,this.y,this.r/1.1,0,Math.PI*2,!0),t.stroke()}}class G{constructor(t,s,r){o(this,"p");o(this,"fp");o(this,"tp");this.p=t,this.fp=s,this.tp=r}drawOnCtx(t){if(this.tp<0||this.fp>1)return;this.tp>1&&(this.tp=1),this.fp<0&&(this.fp=0);let s=this.p.cal(this.tp);t.lineWidth=5,t.beginPath(),t.moveTo(...s);for(let r=this.tp;r>=this.fp&&r<=this.tp;r+=(this.fp-this.tp)/f)s=this.p.cal(r),t.strokeStyle="rgb(255,255,255)",t.lineTo(...s);t.stroke()}}class J{constructor(t,s,r,e="left",a=50,d=new h(255,255,255)){o(this,"text");o(this,"x");o(this,"y");o(this,"align");o(this,"fontSize");o(this,"fill");this.text=t,this.x=s,this.y=r,this.align=e,this.fontSize=a,this.fill=d}drawOnCtx(t){t.fillStyle=`rgba(${this.fill.getColor()[0]},${this.fill.getColor()[1]},${this.fill.getColor()[2]},${this.fill.getColor()[3]})`,t.font=`${this.fontSize}px 'Courier New'`,t.textAlign=this.align,t.fillText(this.text,this.x,this.y)}}class h{constructor(t,s,r,e=1){o(this,"c",[0,0,0,1]);this.c=[t,s,r,e]}getColor(){return this.c}}const et=Object.freeze(Object.defineProperty({__proto__:null,CanvasObject:st,ClackLineCanvasObject:G,EnhancedContent:U,NoteCanvasObject:v,RGBAColor:h,TextCanvasObject:J},Symbol.toStringTag,{value:"Module"}));class Q{constructor(){o(this,"map",new Map)}on(t,s){let r=this.map.get(t);r||(r=new Set,this.map.set(t,r)),r.add(s)}emit(t,s){const r=this.map.get(t);if(!r)return;[...r].forEach(a=>a(s))}}const it=Object.freeze(Object.defineProperty({__proto__:null,EventBus:Q},Symbol.toStringTag,{value:"Module"}));class g{constructor(t){o(this,"notes");o(this,"animationNotes");o(this,"notesTotal");o(this,"length");this.notes=[],this.animationNotes=[],t.notes.forEach(s=>{let r=[];s.paths.forEach(a=>{r.push(g.parsePath(a))});let e=new N(r);s.type!=="I"?this.notes.push(new m(e,s.h,s.track,s.type,s.al)):this.notes.push(new m(e,s.h,s.track,s.type))}),t.animationNotes.forEach(s=>{let r=[];s.paths.forEach(d=>{r.push(g.parsePath(d))});let e=new N(r),a;s.type!=="I"?a=new m(e,s.h,"M",s.type,s.al,s.fill):a=new m(e,s.h,"M",s.type,void 0,s.fill),a.ho=s.ho,a.hi=s.hi,this.animationNotes.push(a)}),this.notesTotal=t.notes.length,this.length=t.length}static parsePath(t){let s=t,r=new y(0);switch(s.type){case"arc":r=new at(s.spd,s.c[0],s.c[1],s.f[0],s.f[1],s.t[0],s.t[1]);break;case"line":r=new ot(s.spd,s.f[0],s.f[1],s.t[0],s.t[1]);break;case"static":r=new rt(s.spd,s.pos[0],s.pos[1]);break;case"pow2":r=new nt(g.parsePath(s.p));break;case"rpow2":r=new ct(g.parsePath(s.p));break;default:throw Error("Invalid path type")}return r}}class y{constructor(t){o(this,"spd");this.spd=t}cal(t){return[0,0]}}class rt extends y{constructor(s,r,e){super(s);o(this,"x");o(this,"y");this.x=r,this.y=e}cal(s){return[this.x,this.y]}}class ot extends y{constructor(s,r,e,a,d){super(s);o(this,"fx");o(this,"fy");o(this,"tx");o(this,"ty");this.fx=r,this.fy=e,this.tx=a,this.ty=d}cal(s){return[this.fx+(this.tx-this.fx)*s,this.fy+(this.ty-this.fy)*s]}}class at extends y{constructor(s,r,e,a,d,I=1600,L=900){super(s);o(this,"cx");o(this,"cy");o(this,"fromx");o(this,"fromy");o(this,"tox");o(this,"toy");if((a-r)**2+(d-e)**2-(I-r)**2-(L-e)**2>=.01)throw Error(`Invalid ArcPath for(${r} ${e} ${a} ${d} ${I} ${L})`);this.cx=r,this.cy=e,this.fromx=a,this.fromy=d,this.tox=I,this.toy=L}cal(s){if(s<0)return[this.fromx,this.fromy];if(s>1)return[this.tox,this.toy];let r=B(this.cx,this.cy,this.fromx,this.fromy),e=B(this.cx,this.cy,this.tox,this.toy),a=r+(e-r)*s,d=Math.sqrt((this.tox-this.cx)**2+(this.toy-this.cy)**2);return[Math.cos(a)*d+this.cx,Math.sin(a)*d+this.cy]}}class W extends y{constructor(s){super(s.spd);o(this,"p");this.p=s}}class nt extends W{constructor(t){super(t)}cal(t){return this.p.cal(t**2)}}class ct extends W{constructor(t){super(t)}cal(t){return this.p.cal((1-t)**2)}}class N extends y{constructor(s){let r=0;s.forEach(a=>{r+=a.spd});super(r);o(this,"ps");o(this,"ssp");this.ps=s,this.ssp=[];let e=0;this.ssp.push(0),s.forEach(a=>{e+=a.spd,this.ssp.push(e/r)})}cal(s){for(let r=1;r<this.ssp.length;r++)if(s<this.ssp[r]){let e=(s-this.ssp[r-1])/(this.ssp[r]-this.ssp[r-1]);return this.ps[r-1].cal(e)}return this.ps[this.ps.length-1].cal(1)}}class m{constructor(t,s,r,e,a,d){o(this,"p");o(this,"h");o(this,"a");o(this,"aa");o(this,"ho");o(this,"hi");o(this,"t");o(this,"y");o(this,"al");o(this,"f");this.p=t,this.h=s,this.t=r,this.y=e,this.a=0,this.aa=0,this.y=="A"&&a==null&&(a=0),this.al=a,this.f=d||[64,64,64]}}const ht=Object.freeze(Object.defineProperty({__proto__:null,Chart:g,Note:m,Path:y},Symbol.toStringTag,{value:"Module"})),C=Object.assign({"/src/charts/atthespeedoflight.json":()=>c(()=>import("./atthespeedoflight-15398c93.js"),[]),"/src/charts/beeper.json":()=>c(()=>import("./beeper-a0223045.js"),[]),"/src/charts/demo.json":()=>c(()=>import("./demo-f6ada2c3.js"),[]),"/src/charts/introduction.json":()=>c(()=>import("./introduction-d894f9d3.js"),[]),"/src/charts/test.json":()=>c(()=>import("./test-2e501a08.js"),[]),"/src/charts/timer.json":()=>c(()=>import("./timer-fbc7f604.js"),[]),"/src/charts/阴游.json":()=>c(()=>import("./阴游-7f321caa.js"),[]),"/src/data/data.json":()=>c(()=>import("./data-3e9ffc66.js"),[]),"/src/data/meta.json":()=>c(()=>import("./meta-f156df76.js"),[]),"/src/finish.ts":()=>c(()=>import("./finish-4040843c.js"),["assets/finish-4040843c.js","assets/preload-helper-8235fac6.js","assets/dynamic-import-helper-be004503.js","assets/util-159a5f05.js","assets/finish-8e0d29c9.css"]),"/src/globals.d.ts":()=>c(()=>import("./globals.d-4ed993c7.js"),[]),"/src/images/atthespeedoflight.png":()=>c(()=>import("./atthespeedoflight-33f5b707.js"),[]),"/src/images/introduction.png":()=>c(()=>import("./introduction-fb03b31b.js"),[]),"/src/player.ts":()=>c(()=>Promise.resolve().then(()=>mt),void 0),"/src/player/chart.ts":()=>c(()=>Promise.resolve().then(()=>ht),void 0),"/src/player/event.ts":()=>c(()=>Promise.resolve().then(()=>it),void 0),"/src/player/gui.ts":()=>c(()=>Promise.resolve().then(()=>et),void 0),"/src/player/sound.ts":()=>c(()=>Promise.resolve().then(()=>pt),void 0),"/src/player/util.ts":()=>c(()=>import("./util-159a5f05.js"),[]),"/src/scripts/introduction.ts":()=>c(()=>import("./introduction-a9299cfa.js"),["assets/introduction-a9299cfa.js","assets/preload-helper-8235fac6.js","assets/util-159a5f05.js"]),"/src/scripts/timer.ts":()=>c(()=>import("./timer-ada3e806.js"),["assets/timer-ada3e806.js","assets/preload-helper-8235fac6.js","assets/util-159a5f05.js"]),"/src/selector.ts":()=>c(()=>import("./selector-b2196534.js"),["assets/selector-b2196534.js","assets/preload-helper-8235fac6.js","assets/dynamic-import-helper-be004503.js","assets/selector-1dc53f68.css"]),"/src/sounds/atthespeedoflight.mp3":()=>c(()=>import("./atthespeedoflight-c73dc3cb.js"),[]),"/src/sounds/beeper.mp3":()=>c(()=>import("./beeper-12d1e476.js"),[]),"/src/sounds/blank.mp3":()=>c(()=>Promise.resolve().then(()=>tt),void 0),"/src/sounds/hit.mp3":()=>c(()=>Promise.resolve().then(()=>Z),void 0),"/src/sounds/introduction.mp3":()=>c(()=>import("./introduction-a26f4fef.js"),[]),"/src/style/finish.css":()=>c(()=>Promise.resolve({}),["assets/finish-8e0d29c9.css"]),"/src/style/player.css":()=>c(()=>Promise.resolve({}),["assets/player-e852206a.css"]),"/src/style/selector.css":()=>c(()=>Promise.resolve({}),["assets/selector-1dc53f68.css"])});console.log(C);class D{constructor(t){o(this,"dir");this.dir=t}async loadAsUrl(t){let s=C[`/src/${this.dir}/${t}`];if(s)return(await s()).default;throw Error("404 Not Found")}async loadAsBase64(t){return ut(await this.loadAsUrl(t))}}class lt extends D{async loadAsUrl(t){return new Promise(s=>{s(`/src/${this.dir}/${t}`)})}async inject(t){let s=C[`/src/${this.dir}/${t}`];if(s)return s();throw Error("404 Not Found")}}class dt extends D{async loadAsUrl(t){return new Promise(s=>{s(`/src/${this.dir}/${t}`)})}async loadAsJson(t){let s=C[`/src/${this.dir}/${t}`];if(s)return s();throw Error("404 Not Found")}}async function ut(i){let t=new XMLHttpRequest,s=new Promise(r=>{t.onload=()=>{let e=new FileReader;e.onloadend=function(){r(e.result)},e.readAsDataURL(t.response)}});return t.open("GET",i),t.responseType="blob",t.send(),s}class j{constructor(t){o(this,"actx");o(this,"audioBuffer");o(this,"volume");o(this,"url","about:blank");o(this,"startTime",0);this.actx=t}play(){this.startTime=Date.now();let t=this.actx.createBufferSource(),s=this.actx.createGain();t.buffer=this.audioBuffer,t.loop=!1,t.connect(s),t.start(0),s.gain.value=this.volume,s.connect(this.actx.destination),console.log(`[sound.ts/EnhancedAudioContext] Audio '${this.url}' played.`),console.debug(t,s,this.actx,this.audioBuffer)}async init(t){let s=this;return this.actx.decodeAudioData(t,function(r){s.audioBuffer=r})}async load(t){return this.url=t,fetch(t).then(s=>s.arrayBuffer()).then(s=>this.init(s)).then(s=>console.log(`[sound.ts/EnhancedAudioContext] Audio '${t}' loaded.`))}setVolume(t){this.volume=t}}class q{constructor(t,s=16){o(this,"enhancedAudioContexts",[]);o(this,"url");o(this,"num");o(this,"loaded",!1);this.url=t,this.num=s}async load(){if(this.loaded)throw Error("Already loaded.");this.loaded=!0;for(let t=0;t<this.num;t++)this.enhancedAudioContexts.push(new j(new AudioContext)),await this.enhancedAudioContexts[t].load(this.url),console.log(`[sound.ts/SoundManager] Audio '${this.url}' loaded for #${t+1}/${this.num}`)}play(){console.debug(this.enhancedAudioContexts);for(let t=0;t<this.num;t++)if(Date.now()-this.enhancedAudioContexts[t].startTime>this.enhancedAudioContexts[t].audioBuffer.length/this.enhancedAudioContexts[t].audioBuffer.sampleRate){this.enhancedAudioContexts[t].play(),console.log(`[sound.ts/SoundManager] Audio '${this.url}' played for #${t+1}/${this.num}`);return}}setVolume(t){for(let s=0;s<this.num;s++)this.enhancedAudioContexts[s].setVolume(t)}}const pt=Object.freeze(Object.defineProperty({__proto__:null,EnhancedAudioContext:j,SoundManager:q},Symbol.toStringTag,{value:"Module"}));let ft=new D("images"),_t=new D("sounds"),wt=new dt("charts"),gt=new lt("scripts"),E,p;const f=60;let T=0,P,w;const yt=.2,At=.1;let A=0,R=0,x=0,b=0,S=!1,O=[],$,n,V=0,u;const l=new Q;function _(i,t,s,r="left",e=50,a=new h(255,255,255)){u.render(new J(i,t,s,r,e,a instanceof h?a:new h(255,255,255,a)))}function k(i){if((n-i.h+i.p.spd)/i.p.spd<0||(n-i.h+i.p.spd)/i.p.spd>1)return;let t=i.p.cal((n-i.h+i.p.spd)/i.p.spd),s;i.t=="A"?s=new h(0,220,240):i.t=="B"?s=new h(220,70,20):s=new h(i.f[0],i.f[1],i.f[2]),u.render(new v(...t,s))}function K(i){i.y=="A"&&((n-i.h+i.p.spd)/i.p.spd<0||(n-i.al-i.h+i.p.spd)/i.p.spd>1||u.render(new G(i.p,(n-i.al-i.h+i.p.spd)/i.p.spd,(n-i.h+i.p.spd)/i.p.spd)))}function M(i){let t=n-i.aa;if(i.a==12&&t<i.hi){let s=i.p.cal(0),r=t/i.hi+1,e=new h(i.f[0],i.f[1],i.f[2],r-1);u.render(new v(...s,e))}else if(i.a==11&&t<i.ho){let s=i.p.cal(1),r=t/i.ho+1,e=new h(i.f[0],i.f[1],i.f[2],2-r);u.render(new v(...s,e))}else if(i.a>0&&t<.25){let s=t/.25+1,r=i.p.cal(1),e=new h(0,0,0,0);i.a==1?e=new h(160,144,0,2-s):i.a==2&&(e=new h(0,167,195,2-s)),u.render(new v(...r,e,s*88))}}function Et(){E.fillStyle="rgb(255,255,255)",E.font="50px 'Courier New'",E.textAlign="center",_(`${T}`,1600,60,"center"),_("COMBO",1600,120,"center"),_(`Point: ${(A/p.notesTotal/100*1e5).toFixed(0)}`,3150,60,"right"),_(`Music: ${(n/p.length*100).toFixed(2)}%`,3150,120,"right");{let i=O.length,t=new h(255,0,255);i/f>=0&&(t=new h(255,0,255)),i/f>.3&&(t=new h(255,0,63)),i/f>.6&&(t=new h(255,0,0)),i/f>.9&&(t=new h(255,127,0)),i/f>.95&&(t=new h(255,255,0)),i/f>.999&&(t=new h(0,255,0)),i/f>.99999&&(t=new h(0,255,255)),_(`TPS: ${i.toFixed(0)}/${f}`,3150,180,"right",50,t),_(`Sec: ${n.toFixed(3)} Paused: ${V.toFixed(3)} Total: ${((Date.now()-$)/1e3).toFixed(3)} Music: ${w.actx.currentTime.toFixed(3)}`,3150,240,"right")}}function xt(){u.clear()}async function bt(){let i=X("id");if(document.getElementById("canvas_box").style.backgroundImage=`url(${await ft.loadAsUrl(`${i}.png`).catch(()=>"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2P4DwQACfsD/Z8fLAAAAAAASUVORK5CYII=")})`,E=document.getElementById("main_canvas").getContext("2d"),u=new U(E),u.setBackGroundColor("rgba(0,0,0,0.5)"),u.clear(),_("游戏正在加载",1600,900,"center",200,new h(200,200,200)),l.on("hit",function(r){T++,R=Math.max(T,R),r==1?(A+=100,x+=1):r==2&&(A+=75,b+=1)}),l.on("hit",()=>{P.play()}),l.on("miss",()=>{T=0}),l.on("tick",()=>{let r=Date.now();for(O.push(r);r-O[0]>=1e3;)O.splice(0,1)}),l.on("start",()=>{$=Date.now()-w.actx.currentTime*1e3}),document.addEventListener("keydown",r=>{let e=!1;r.keyCode==65&&(p.notes.forEach(a=>{e||a.a||a.t!="A"||(Math.abs(a.h-n)<=.08?(e=!0,a.a=1,a.aa=n,l.emit("hit",1)):Math.abs(a.h-n)<=.16&&(e=!0,a.a=2,a.aa=n,l.emit("hit",2)))}),e||l.emit("miss",null)),r.keyCode==76&&(p.notes.forEach(a=>{e||a.a||a.t!="B"||(Math.abs(a.h-n)<=.08?(e=!0,a.a=1,a.aa=n,l.emit("hit",1)):Math.abs(a.h-n)<=.16&&(e=!0,a.a=2,a.aa=n,l.emit("hit",2)))}),e||l.emit("miss",null))}),document.addEventListener("keyup",r=>{r.keyCode==65&&p.notes.forEach(e=>{e.a<=0||e.t!="A"||e.y!="A"||e.h+e.al-n>0&&e.h-n<0&&(A-=e.a==1?100:75,e.a==1?x--:b--,e.a=-1,e.aa=0,l.emit("miss",null))}),r.keyCode==76&&p.notes.forEach(e=>{e.a<=0||e.t!="B"||e.y!="A"||e.h+e.al-n>0&&e.h-n<0&&(A-=e.a==1?100:75,e.a==1?x--:b--,e.a=-1,e.aa=0,l.emit("miss",null))})}),i==null)throw u.clear(),_("游戏加载错误，请尝试刷新",1600,900,"center",200,new h(200,200,200)),new Error("No data file given.");let s;if(await wt.loadAsJson(`${i}.json`).then(async r=>s=r.default),s==null)throw u.clear(),_("游戏加载错误，请尝试刷新",1600,900,"center",200,new h(200,200,200)),new Error("Data file has nothing or corrupted or not exist.");s.script&&await gt.inject(s.script),u.clear(),_("点击屏幕开始",1600,900,"center",200,new h(230,230,230)),await new Promise(r=>{document.onclick=()=>{document.onclick=null,r(null)}}),P=new q(z),w=new j(new AudioContext),await P.load(),s.bgsound?await w.load(await _t.loadAsUrl(s.bgsound)):await w.load(F),w.setVolume(At),P.setVolume(yt),p=new g(s),l.on("start",()=>{let r=setInterval(async function(){if(S){V=(Date.now()-$)/1e3-n;return}xt(),n=(Date.now()-$)/1e3-V,l.emit("tick",n),p.animationNotes.forEach(e=>{e.a==12&&n-e.aa>e.hi?(e.a=0,e.aa=0):Math.abs(e.h-n)<=1.5/f?e.ho&&(e.a=11,e.aa=n):e.hi!=null&&Math.abs(e.h-e.p.spd-e.hi-n)<=1.5/f&&(e.a=12,e.aa=n),k(e),M(e)}),p.notes.forEach(e=>{K(e)}),p.notes.forEach(e=>{n-e.h>.16&&!e.a&&(e.a=-1,l.emit("miss",null)),k(e)}),p.notes.forEach(e=>{M(e)}),Et(),n>=s.length&&(clearInterval(r),S=!0,location.replace(`./finish.html?i=${i}&c=${R}&t=${(A/p.notesTotal/100*1e5).toFixed(0)}&p=${x}&g=${b}&m=${p.notesTotal-x-b}`))},1e3/f)}),u.clear(),w.play(),l.emit("start",null)}window.onload=bt;const mt=Object.freeze(Object.defineProperty({__proto__:null,bus:l,get ctx(){return E},drawA:M,drawClackLine:K,drawNote:k,get paused(){return S},renderText:_,get sec(){return n},tps:f},Symbol.toStringTag,{value:"Module"}));export{l as b,_ as r};
