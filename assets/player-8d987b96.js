var W=Object.defineProperty;var K=(t,i,a)=>i in t?W(t,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[i]=a;var e=(t,i,a)=>(K(t,typeof i!="symbol"?i+"":i,a),a);import{a as m,_ as l}from"./dynamic-import-helper-6cac4324.js";import Y from"./hit-c1377711.js";import q from"./blank-8d2f1394.js";class J{constructor(i){e(this,"ctx");e(this,"backGroundColor","rgba(0,0,0,0)");e(this,"size",[300,150]);this.ctx=i,this.size=[parseInt(this.ctx.canvas.getAttribute("width")||"300"),parseInt(this.ctx.canvas.getAttribute("height")||"150")]}setBackGroundColor(i){this.backGroundColor=i}clear(){this.ctx.fillStyle=this.backGroundColor,this.ctx.clearRect(0,0,...this.size),this.ctx.fillRect(0,0,...this.size)}render(i){i.drawOnCtx(this.ctx)}}class I{constructor(i=-100,a=-100,r=new n(64,64,64),s=88){e(this,"x",-100);e(this,"y",-100);e(this,"f",new n(64,64,64));e(this,"r",88);this.x=i,this.y=a,this.f=r,this.r=s}drawOnCtx(i){i.fillStyle=`rgba(${this.f.getColor()[0]},${this.f.getColor()[1]},${this.f.getColor()[2]},${this.f.getColor()[3]})`,i.beginPath(),i.arc(this.x,this.y,this.r,0,Math.PI*2,!0),i.fill(),i.lineWidth=2,i.strokeStyle=`rgba(255,255,255,${this.f.getColor()[3]})`,i.beginPath(),i.arc(this.x,this.y,this.r/1.1,0,Math.PI*2,!0),i.stroke()}}class Z{constructor(i,a,r){e(this,"p");e(this,"fp");e(this,"tp");this.p=i,this.fp=a,this.tp=r}drawOnCtx(i){if(this.tp<0||this.fp>1)return;this.tp>1&&(this.tp=1),this.fp<0&&(this.fp=0);let a=this.p.cal(this.tp);i.lineWidth=5,i.beginPath(),i.moveTo(...a);for(let r=this.tp;r>=this.fp&&r<=this.tp;r+=(this.fp-this.tp)/d)a=this.p.cal(r),i.strokeStyle="rgb(255,255,255)",i.lineTo(...a);i.stroke()}}class X{constructor(i,a,r,s="left",o=50,p=new n(255,255,255)){e(this,"text");e(this,"x");e(this,"y");e(this,"align");e(this,"fontSize");e(this,"fill");this.text=i,this.x=a,this.y=r,this.align=s,this.fontSize=o,this.fill=p}drawOnCtx(i){i.fillStyle=`rgba(${this.fill.getColor()[0]},${this.fill.getColor()[1]},${this.fill.getColor()[2]},${this.fill.getColor()[3]})`,i.font=`${this.fontSize}px 'Courier New'`,i.textAlign=this.align,i.fillText(this.text,this.x,this.y)}}class n{constructor(i,a,r,s=1){e(this,"c",[0,0,0,1]);this.c=[i,a,r,s]}getColor(){return this.c}}class tt{constructor(){e(this,"map",new Map)}on(i,a){let r=this.map.get(i);r||(r=new Set,this.map.set(i,r)),r.add(a)}emit(i,a){const r=this.map.get(i);if(!r)return;[...r].forEach(o=>o(a))}}let P,A=[],H=[],d=144,f=null,C=0,E=null,L=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],w=null,V=.2,y=0,R=0,U=0,M=0,x=0,v=0,j=!1,$=[],g=0,T=Date.now(),h=0,S=0,u;const c=new tt;class b{constructor(i){e(this,"spd");this.spd=i}cal(i){return[0,0]}}class it extends b{constructor(a,r,s){super(a);e(this,"x");e(this,"y");this.x=r,this.y=s}cal(a){return[this.x,this.y]}}class st extends b{constructor(a,r,s,o,p){super(a);e(this,"fx");e(this,"fy");e(this,"tx");e(this,"ty");this.fx=r,this.fy=s,this.tx=o,this.ty=p}cal(a){return[this.fx+(this.tx-this.fx)*a,this.fy+(this.ty-this.fy)*a]}}class rt extends b{constructor(a,r,s,o,p,k=1600,D=900){super(a);e(this,"cx");e(this,"cy");e(this,"fromx");e(this,"fromy");e(this,"tox");e(this,"toy");if((o-r)**2+(p-s)**2-(k-r)**2-(D-s)**2>=.01)throw Error(`Invalid ArcPath for(${r} ${s} ${o} ${p} ${k} ${D})`);this.cx=r,this.cy=s,this.fromx=o,this.fromy=p,this.tox=k,this.toy=D}cal(a){if(a<0)return[this.fromx,this.fromy];if(a>1)return[this.tox,this.toy];let r=F(this.cx,this.cy,this.fromx,this.fromy),s=F(this.cx,this.cy,this.tox,this.toy),o=r+(s-r)*a,p=Math.sqrt((this.tox-this.cx)**2+(this.toy-this.cy)**2);return[Math.cos(o)*p+this.cx,Math.sin(o)*p+this.cy]}}class Q extends b{constructor(a){super(a.spd);e(this,"p");this.p=a}}class at extends Q{constructor(i){super(i)}cal(i){return this.p.cal(i**2)}}class et extends Q{constructor(i){super(i)}cal(i){return this.p.cal((1-i)**2)}}class B extends b{constructor(a){let r=0;a.forEach(o=>{r+=o.spd});super(r);e(this,"ps");e(this,"ssp");this.ps=a,this.ssp=[];let s=0;this.ssp.push(0),a.forEach(o=>{s+=o.spd,this.ssp.push(s/r)})}cal(a){for(let r=1;r<this.ssp.length;r++)if(a<this.ssp[r]){let s=(a-this.ssp[r-1])/(this.ssp[r]-this.ssp[r-1]);return this.ps[r-1].cal(s)}return this.ps[this.ps.length-1].cal(1)}}class N{constructor(i,a,r,s,o,p){e(this,"p");e(this,"h");e(this,"a");e(this,"aa");e(this,"ho");e(this,"hi");e(this,"t");e(this,"y");e(this,"al");e(this,"f");this.p=i,this.h=a,this.t=r,this.y=s,this.a=0,this.aa=0,this.y=="A"&&o==null&&(o=0),this.al=o,this.f=p||[64,64,64]}}function _(t,i,a,r="left",s=50,o=new n(255,255,255)){u.render(new X(t,i,a,r,s,o instanceof n?o:new n(255,255,255,o)))}function ot(t){let i=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),a=window.location.search.substr(1).match(i);return a!=null?decodeURIComponent(a[2]):null}function F(t,i,a,r){return r==i?Math.PI:r<i?Math.PI/2-Math.atan((a-t)/(r-i))+Math.PI:Math.PI/2-Math.atan((a-t)/(r-i))}function G(t){if((h-t.h+t.p.spd)/t.p.spd<0||(h-t.h+t.p.spd)/t.p.spd>1)return;let i=t.p.cal((h-t.h+t.p.spd)/t.p.spd),a;t.t=="A"?a=new n(0,220,240):t.t=="B"?a=new n(220,70,20):a=new n(t.f[0],t.f[1],t.f[2]),u.render(new I(...i,a))}function ht(t){t.y=="A"&&((h-t.h+t.p.spd)/t.p.spd<0||(h-t.al-t.h+t.p.spd)/t.p.spd>1||u.render(new Z(t.p,(h-t.al-t.h+t.p.spd)/t.p.spd,(h-t.h+t.p.spd)/t.p.spd)))}function z(t){let i=h-t.aa;if(t.a==12&&i<t.hi){let a=t.p.cal(0),r=i/t.hi+1,s=new n(t.f[0],t.f[1],t.f[2],r-1);u.render(new I(...a,s))}else if(t.a==11&&i<t.ho){let a=t.p.cal(1),r=i/t.ho+1,s=new n(t.f[0],t.f[1],t.f[2],2-r);u.render(new I(...a,s))}else if(t.a>0&&i<.25){let a=i/.25+1,r=t.p.cal(1),s=new n(0,0,0,0);t.a==1?s=new n(160,144,0,2-a):t.a==2&&(s=new n(0,167,195,2-a)),u.render(new I(...r,s,a*88))}}function nt(){P.fillStyle="rgb(255,255,255)",P.font="50px 'Courier New'",P.textAlign="center",_(`${C}`,1600,60,"center"),_("COMBO",1600,120,"center"),_(`Point: ${(y/R*1e5).toFixed(0)}`,3150,60,"right"),_(`Music: ${(h/f.length*100).toFixed(2)}%`,3150,120,"right");{g=$.length;let t=new n(255,0,255);g/d>=0&&(t=new n(255,0,255)),g/d>.3&&(t=new n(255,0,63)),g/d>.6&&(t=new n(255,0,0)),g/d>.9&&(t=new n(255,127,0)),g/d>.95&&(t=new n(255,255,0)),g/d>.999&&(t=new n(0,255,0)),g/d>.99999&&(t=new n(0,255,255)),_(`TPS: ${g.toFixed(2)}/${d}`,3150,180,"right",50,t),_(`Sec: ${h.toFixed(3)} Paused: ${S.toFixed(3)} Total: ${((Date.now()-T)/1e3).toFixed(3)} Music: ${w.currentTime.toFixed(3)}`,3150,240,"right")}}function O(t){let i=t,a=new b(0);switch(i.type){case"arc":a=new rt(i.spd,i.c[0],i.c[1],i.f[0],i.f[1],i.t[0],i.t[1]);break;case"line":a=new st(i.spd,i.f[0],i.f[1],i.t[0],i.t[1]);break;case"static":a=new it(i.spd,i.pos[0],i.pos[1]);break;case"pow2":a=new at(O(i.p));break;case"rpow2":a=new et(O(i.p));break;default:throw Error("Invalid path type")}return a}function ct(){if(f===null)throw Error("Song not loaded");f.notes.forEach(t=>{let i=[];t.paths.forEach(r=>{i.push(O(r))});let a=new B(i);A.push(new N(a,t.h,t.track,t.type,t.al))}),f.animationNotes.forEach(t=>{let i=[];t.paths.forEach(s=>{i.push(O(s))});let a=new B(i),r=new N(a,t.h,"M",t.type,t.al,t.fill);r.ho=t.ho,r.hi=t.hi,H.push(r)}),R=f.notes.length*100,U=f.notes.length}function lt(){u.clear()}async function pt(){let t=ot("id");if(document.getElementById("canvas_box").style.backgroundImage=`url(${(await m(Object.assign({"./images/atthespeedoflight.png":()=>l(()=>import("./atthespeedoflight-33f5b707.js"),[]),"./images/introduction.png":()=>l(()=>import("./introduction-fb03b31b.js"),[])}),`./images/${t}.png`).catch(r=>({default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2P4DwQACfsD/Z8fLAAAAAAASUVORK5CYII="}))).default})`,P=document.getElementById("main_canvas").getContext("2d"),u=new J(P),u.setBackGroundColor("rgba(0,0,0,0.5)"),u.clear(),_("游戏正在加载",1600,900,"center",200,new n(200,200,200)),c.on("hit",function(r){C++,M=Math.max(C,M),r==1?(y+=100,x+=1):r==2&&(y+=75,v+=1)}),c.on("hit",function(r){for(let s=0;s<16;s++)if(Date.now()>L[s]){E[s].play(),L[s]=Date.now()+200,console.log(`Playing hit ${s}`);break}}),c.on("miss",function(r){C=0}),c.on("tick",function(r){let s=Date.now();for($.push(s);s-$[0]>=1e3;)$.splice(0,1)}),c.on("start",function(r){T=Date.now()-w.currentTime*1e3}),document.addEventListener("keydown",r=>{let s=!1;r.keyCode==65&&(A.forEach(o=>{s||o.a||o.t!="A"||(Math.abs(o.h-h)<=.08?(s=!0,o.a=1,o.aa=h,c.emit("hit",1)):Math.abs(o.h-h)<=.16&&(s=!0,o.a=2,o.aa=h,c.emit("hit",2)))}),s||c.emit("miss",null)),r.keyCode==76&&(A.forEach(o=>{s||o.a||o.t!="B"||(Math.abs(o.h-h)<=.08?(s=!0,o.a=1,o.aa=h,c.emit("hit",1)):Math.abs(o.h-h)<=.16&&(s=!0,o.a=2,o.aa=h,c.emit("hit",2)))}),s||c.emit("miss",null))}),document.addEventListener("keyup",r=>{r.keyCode==65&&A.forEach(s=>{s.a<=0||s.t!="A"||s.y!="A"||s.h+s.al-h>0&&s.h-h<0&&(y-=s.a==1?100:75,s.a==1?x--:v--,s.a=-1,s.aa=0,c.emit("miss",null))}),r.keyCode==76&&A.forEach(s=>{s.a<=0||s.t!="B"||s.y!="A"||s.h+s.al-h>0&&s.h-h<0&&(y-=s.a==1?100:75,s.a==1?x--:v--,s.a=-1,s.aa=0,c.emit("miss",null))})}),t==null)throw u.clear(),_("游戏加载错误，请尝试刷新",1600,900,"center",200,new n(200,200,200)),new Error("No data file given.");if(await m(Object.assign({"./charts/atthespeedoflight.json":()=>l(()=>import("./atthespeedoflight-2ce65557.js"),[]),"./charts/beeper.json":()=>l(()=>import("./beeper-6116af75.js"),[]),"./charts/demo.json":()=>l(()=>import("./demo-f6ada2c3.js"),[]),"./charts/introduction.json":()=>l(()=>import("./introduction-b282d266.js"),[]),"./charts/test.json":()=>l(()=>import("./test-2e501a08.js"),[]),"./charts/timer.json":()=>l(()=>import("./timer-cf0307e0.js"),[]),"./charts/阴游.json":()=>l(()=>import("./阴游-7f321caa.js"),[])}),`./charts/${t}.json`).then(async r=>f=r.default),f==null)throw u.clear(),_("游戏加载错误，请尝试刷新",1600,900,"center",200,new n(200,200,200)),new Error("Data file has nothing or corrupted or not exist.");f.script&&await m(Object.assign({"./scripts/introduction.ts":()=>l(()=>import("./introduction-0da72b62.js"),["assets/introduction-0da72b62.js","assets/dynamic-import-helper-6cac4324.js","assets/hit-c1377711.js","assets/blank-8d2f1394.js"]),"./scripts/timer.ts":()=>l(()=>import("./timer-b967d28b.js"),["assets/timer-b967d28b.js","assets/dynamic-import-helper-6cac4324.js","assets/hit-c1377711.js","assets/blank-8d2f1394.js"])}),`./scripts/${f.script}.ts`),E=[];for(let r=0;r<16;r++)E.push(new Audio(Y));if(f.bgsound?w=new Audio((await m(Object.assign({"./sounds/atthespeedoflight.mp3":()=>l(()=>import("./atthespeedoflight-c73dc3cb.js"),[]),"./sounds/beeper.mp3":()=>l(()=>import("./beeper-12d1e476.js"),[]),"./sounds/blank.mp3":()=>l(()=>import("./blank-8d2f1394.js"),[]),"./sounds/hit.mp3":()=>l(()=>import("./hit-c1377711.js"),[]),"./sounds/introduction.mp3":()=>l(()=>import("./introduction-a26f4fef.js"),[])}),`./sounds/${f.bgsound}.mp3`)).default):w=new Audio(q),/[\s\S]*(iPhone|iPad|iPod)[\s\S]*/.test(navigator.userAgent)){w.load();for(let r=0;r<16;r++)E[r].load()}await new Promise(r=>{let s=setInterval(()=>{E[0].readyState==HTMLMediaElement.HAVE_ENOUGH_DATA&&w.readyState==HTMLMediaElement.HAVE_ENOUGH_DATA&&(clearInterval(s),r(null))},10)}),w.volume=.5*V,E.forEach(r=>{r.volume=1*V}),ct(),u.clear();let a=setInterval(()=>{w.currentTime>0&&(clearInterval(a),c.emit("start",null))},1);w.play().catch(async r=>{alert("您未开启音频自动播放，请关闭弹窗后点击屏幕开始游戏。"),await new Promise(s=>{document.onclick=o=>{s(null),document.onclick=null}}),w.play()}),c.on("start",()=>{let r=setInterval(async function(){if(j){S=(Date.now()-T)/1e3-h;return}lt(),h=(Date.now()-T)/1e3-S,c.emit("tick",h),H.forEach(s=>{s.a==12&&h-s.aa>s.hi?(s.a=0,s.aa=0):Math.abs(s.h-h)<=1.5/d?s.ho&&(s.a=11,s.aa=h):s.hi!=null&&Math.abs(s.h-s.p.spd-s.hi-h)<=1.5/d&&(s.a=12,s.aa=h),G(s),z(s)}),A.forEach(s=>{ht(s)}),A.forEach(s=>{h-s.h>.16&&!s.a&&(s.a=-1,c.emit("miss",null)),G(s)}),A.forEach(s=>{z(s)}),nt(),h>=f.length&&(clearInterval(r),j=!0,location.replace(`./finish.html?i=${t}&c=${M}&t=${(y/R*1e5).toFixed(0)}&p=${x}&g=${v}&m=${U-x-v}`))},1e3/d)})}window.onload=pt;export{c as b,_ as r};
