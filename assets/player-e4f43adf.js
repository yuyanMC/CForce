var q=Object.defineProperty;var Q=(t,s,r)=>s in t?q(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r;var e=(t,s,r)=>(Q(t,typeof s!="symbol"?s+"":s,r),r);import{_ as u}from"./preload-helper-8235fac6.js";import{_ as O}from"./dynamic-import-helper-be004503.js";const J="/assets/hit-7d4160ed.mp3",K="/assets/blank-d6053d36.mp3";class X{constructor(s){e(this,"ctx");e(this,"backGroundColor","rgba(0,0,0,0)");e(this,"size",[300,150]);this.ctx=s,this.size=[parseInt(this.ctx.canvas.getAttribute("width")||"300"),parseInt(this.ctx.canvas.getAttribute("height")||"150")]}setBackGroundColor(s){this.backGroundColor=s}clear(){this.ctx.fillStyle=this.backGroundColor,this.ctx.clearRect(0,0,...this.size),this.ctx.fillRect(0,0,...this.size)}render(s){s.drawOnCtx(this.ctx)}}class A{constructor(s=-100,r=-100,a=new n(64,64,64),i=88){e(this,"x",-100);e(this,"y",-100);e(this,"f",new n(64,64,64));e(this,"r",88);this.x=s,this.y=r,this.f=a,this.r=i}drawOnCtx(s){s.fillStyle=`rgba(${this.f.getColor()[0]},${this.f.getColor()[1]},${this.f.getColor()[2]},${this.f.getColor()[3]})`,s.beginPath(),s.arc(this.x,this.y,this.r,0,Math.PI*2,!0),s.fill(),s.lineWidth=2,s.strokeStyle=`rgba(255,255,255,${this.f.getColor()[3]})`,s.beginPath(),s.arc(this.x,this.y,this.r/1.1,0,Math.PI*2,!0),s.stroke()}}class Y{constructor(s,r,a){e(this,"p");e(this,"fp");e(this,"tp");this.p=s,this.fp=r,this.tp=a}drawOnCtx(s){if(this.tp<0||this.fp>1)return;this.tp>1&&(this.tp=1),this.fp<0&&(this.fp=0);let r=this.p.cal(this.tp);s.lineWidth=5,s.beginPath(),s.moveTo(...r);for(let a=this.tp;a>=this.fp&&a<=this.tp;a+=(this.fp-this.tp)/d)r=this.p.cal(a),s.strokeStyle="rgb(255,255,255)",s.lineTo(...r);s.stroke()}}class Z{constructor(s,r,a,i="left",o=50,l=new n(255,255,255)){e(this,"text");e(this,"x");e(this,"y");e(this,"align");e(this,"fontSize");e(this,"fill");this.text=s,this.x=r,this.y=a,this.align=i,this.fontSize=o,this.fill=l}drawOnCtx(s){s.fillStyle=`rgba(${this.fill.getColor()[0]},${this.fill.getColor()[1]},${this.fill.getColor()[2]},${this.fill.getColor()[3]})`,s.font=`${this.fontSize}px 'Courier New'`,s.textAlign=this.align,s.fillText(this.text,this.x,this.y)}}class n{constructor(s,r,a,i=1){e(this,"c",[0,0,0,1]);this.c=[s,r,a,i]}getColor(){return this.c}}class tt{constructor(){e(this,"map",new Map)}on(s,r){let a=this.map.get(s);a||(a=new Set,this.map.set(s,a)),a.add(r)}emit(s,r){const a=this.map.get(s);if(!a)return;[...a].forEach(o=>o(r))}}let $,_=[],H=[],d=144,p=null,m=0,E=null,R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],w=null,j=.2,y=0,L=0,U=0,D=0,v=0,P=0,V=!1,C=[],g=0,I=Date.now(),h=0,S=0,f;const c=new tt;class x{constructor(s){e(this,"spd");this.spd=s}cal(s){return[0,0]}}class st extends x{constructor(r,a,i){super(r);e(this,"x");e(this,"y");this.x=a,this.y=i}cal(r){return[this.x,this.y]}}class it extends x{constructor(r,a,i,o,l){super(r);e(this,"fx");e(this,"fy");e(this,"tx");e(this,"ty");this.fx=a,this.fy=i,this.tx=o,this.ty=l}cal(r){return[this.fx+(this.tx-this.fx)*r,this.fy+(this.ty-this.fy)*r]}}class at extends x{constructor(r,a,i,o,l,T=1600,M=900){super(r);e(this,"cx");e(this,"cy");e(this,"fromx");e(this,"fromy");e(this,"tox");e(this,"toy");if((o-a)**2+(l-i)**2-(T-a)**2-(M-i)**2>=.01)throw Error(`Invalid ArcPath for(${a} ${i} ${o} ${l} ${T} ${M})`);this.cx=a,this.cy=i,this.fromx=o,this.fromy=l,this.tox=T,this.toy=M}cal(r){if(r<0)return[this.fromx,this.fromy];if(r>1)return[this.tox,this.toy];let a=F(this.cx,this.cy,this.fromx,this.fromy),i=F(this.cx,this.cy,this.tox,this.toy),o=a+(i-a)*r,l=Math.sqrt((this.tox-this.cx)**2+(this.toy-this.cy)**2);return[Math.cos(o)*l+this.cx,Math.sin(o)*l+this.cy]}}class W extends x{constructor(r){super(r.spd);e(this,"p");this.p=r}}class rt extends W{constructor(s){super(s)}cal(s){return this.p.cal(s**2)}}class et extends W{constructor(s){super(s)}cal(s){return this.p.cal((1-s)**2)}}class B extends x{constructor(r){let a=0;r.forEach(o=>{a+=o.spd});super(a);e(this,"ps");e(this,"ssp");this.ps=r,this.ssp=[];let i=0;this.ssp.push(0),r.forEach(o=>{i+=o.spd,this.ssp.push(i/a)})}cal(r){for(let a=1;a<this.ssp.length;a++)if(r<this.ssp[a]){let i=(r-this.ssp[a-1])/(this.ssp[a]-this.ssp[a-1]);return this.ps[a-1].cal(i)}return this.ps[this.ps.length-1].cal(1)}}class N{constructor(s,r,a,i,o,l){e(this,"p");e(this,"h");e(this,"a");e(this,"aa");e(this,"ho");e(this,"hi");e(this,"t");e(this,"y");e(this,"al");e(this,"f");this.p=s,this.h=r,this.t=a,this.y=i,this.a=0,this.aa=0,this.y=="A"&&o==null&&(o=0),this.al=o,this.f=l||[64,64,64]}}function b(t,s,r,a="left",i=50,o=new n(255,255,255)){f.render(new Z(t,s,r,a,i,o instanceof n?o:new n(255,255,255,o)))}function ot(t){let s=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),r=window.location.search.substr(1).match(s);return r!=null?decodeURIComponent(r[2]):null}function F(t,s,r,a){return a==s?Math.PI:a<s?Math.PI/2-Math.atan((r-t)/(a-s))+Math.PI:Math.PI/2-Math.atan((r-t)/(a-s))}function G(t){if((h-t.h+t.p.spd)/t.p.spd<0||(h-t.h+t.p.spd)/t.p.spd>1)return;let s=t.p.cal((h-t.h+t.p.spd)/t.p.spd),r;t.t=="A"?r=new n(0,220,240):t.t=="B"?r=new n(220,70,20):r=new n(t.f[0],t.f[1],t.f[2]),f.render(new A(...s,r))}function ht(t){t.y=="A"&&((h-t.h+t.p.spd)/t.p.spd<0||(h-t.al-t.h+t.p.spd)/t.p.spd>1||f.render(new Y(t.p,(h-t.al-t.h+t.p.spd)/t.p.spd,(h-t.h+t.p.spd)/t.p.spd)))}function z(t){let s=h-t.aa;if(t.a==12&&s<t.hi){let r=t.p.cal(0),a=s/t.hi+1,i=new n(t.f[0],t.f[1],t.f[2],a-1);f.render(new A(...r,i))}else if(t.a==11&&s<t.ho){let r=t.p.cal(1),a=s/t.ho+1,i=new n(t.f[0],t.f[1],t.f[2],2-a);f.render(new A(...r,i))}else if(t.a>0&&s<.25){let r=s/.25+1,a=t.p.cal(1),i=new n(0,0,0,0);t.a==1?i=new n(160,144,0,2-r):t.a==2&&(i=new n(0,167,195,2-r)),f.render(new A(...a,i,r*88))}}function nt(){$.fillStyle="rgb(255,255,255)",$.font="50px 'Courier New'",$.textAlign="center",b(`${m}`,1600,60,"center"),b("COMBO",1600,120,"center"),b(`Point: ${(y/L*1e5).toFixed(0)}`,3150,60,"right"),b(`Music: ${(h/p.length*100).toFixed(2)}%`,3150,120,"right");{g=C.length;let t=new n(255,0,255);g/d>=0&&(t=new n(255,0,255)),g/d>.3&&(t=new n(255,0,63)),g/d>.6&&(t=new n(255,0,0)),g/d>.9&&(t=new n(255,127,0)),g/d>.95&&(t=new n(255,255,0)),g/d>.999&&(t=new n(0,255,0)),g/d>.99999&&(t=new n(0,255,255)),b(`TPS: ${g.toFixed(2)}/${d}`,3150,180,"right",50,t),b(`Sec: ${h.toFixed(3)} Paused: ${S.toFixed(3)} Total: ${((Date.now()-I)/1e3).toFixed(3)} Music: ${w.currentTime.toFixed(3)}`,3150,240,"right")}}function k(t){let s=t,r=new x(0);switch(s.type){case"arc":r=new at(s.spd,s.c[0],s.c[1],s.f[0],s.f[1],s.t[0],s.t[1]);break;case"line":r=new it(s.spd,s.f[0],s.f[1],s.t[0],s.t[1]);break;case"static":r=new st(s.spd,s.pos[0],s.pos[1]);break;case"pow2":r=new rt(k(s.p));break;case"rpow2":r=new et(k(s.p));break;default:throw Error("Invalid path type")}return r}function ct(){if(p===null)throw Error("Song not loaded");p.notes.forEach(t=>{let s=[];t.paths.forEach(a=>{s.push(k(a))});let r=new B(s);_.push(new N(r,t.h,t.track,t.type,t.al))}),p.animationNotes.forEach(t=>{let s=[];t.paths.forEach(i=>{s.push(k(i))});let r=new B(s),a=new N(r,t.h,"M",t.type,t.al,t.fill);a.ho=t.ho,a.hi=t.hi,H.push(a)}),L=p.notes.length*100,U=p.notes.length}function lt(){f.clear()}async function pt(){let t=ot("id");if(document.getElementById("canvas_box").style.backgroundImage=`url(${(await O(Object.assign({"../public/assets/images/atthespeedoflight.png":()=>u(()=>import("./atthespeedoflight-33f5b707.js"),[]),"../public/assets/images/introduction.png":()=>u(()=>import("./introduction-fb03b31b.js"),[])}),`../public/assets/images/${t}.png`)).default})`,$=document.getElementById("main_canvas").getContext("2d"),f=new X($),f.setBackGroundColor("rgba(0,0,0,0.5)"),f.clear(),b("游戏正在加载",1600,900,"center",200,new n(200,200,200)),c.on("hit",function(a){m++,D=Math.max(m,D),a==1?(y+=100,v+=1):a==2&&(y+=75,P+=1)}),c.on("hit",function(a){for(let i=0;i<16;i++)if(Date.now()>R[i]){E[i].play(),R[i]=Date.now()+200,console.log(`Playing hit ${i}`);break}}),c.on("miss",function(a){m=0}),c.on("tick",function(a){let i=Date.now();for(C.push(i);i-C[0]>=1e3;)C.splice(0,1)}),c.on("start",function(a){I=Date.now()-w.currentTime*1e3}),document.addEventListener("keydown",a=>{let i=!1;a.keyCode==65&&(_.forEach(o=>{i||o.a||o.t!="A"||(Math.abs(o.h-h)<=.08?(i=!0,o.a=1,o.aa=h,c.emit("hit",1)):Math.abs(o.h-h)<=.16&&(i=!0,o.a=2,o.aa=h,c.emit("hit",2)))}),i||c.emit("miss",null)),a.keyCode==76&&(_.forEach(o=>{i||o.a||o.t!="B"||(Math.abs(o.h-h)<=.08?(i=!0,o.a=1,o.aa=h,c.emit("hit",1)):Math.abs(o.h-h)<=.16&&(i=!0,o.a=2,o.aa=h,c.emit("hit",2)))}),i||c.emit("miss",null))}),document.addEventListener("keyup",a=>{a.keyCode==65&&_.forEach(i=>{i.a<=0||i.t!="A"||i.y!="A"||i.h+i.al-h>0&&i.h-h<0&&(y-=i.a==1?100:75,i.a==1?v--:P--,i.a=-1,i.aa=0,c.emit("miss",null))}),a.keyCode==76&&_.forEach(i=>{i.a<=0||i.t!="B"||i.y!="A"||i.h+i.al-h>0&&i.h-h<0&&(y-=i.a==1?100:75,i.a==1?v--:P--,i.a=-1,i.aa=0,c.emit("miss",null))})}),t==null)throw f.clear(),b("游戏加载错误，请尝试刷新",1600,900,"center",200,new n(200,200,200)),new Error("No data file given.");if(await O(Object.assign({"../public/assets/charts/atthespeedoflight.json":()=>u(()=>import("./atthespeedoflight-15398c93.js"),[]),"../public/assets/charts/beeper.json":()=>u(()=>import("./beeper-a0223045.js"),[]),"../public/assets/charts/demo.json":()=>u(()=>import("./demo-f6ada2c3.js"),[]),"../public/assets/charts/introduction.json":()=>u(()=>import("./introduction-7019cf49.js"),[]),"../public/assets/charts/test.json":()=>u(()=>import("./test-2e501a08.js"),[]),"../public/assets/charts/timer.json":()=>u(()=>import("./timer-62c64910.js"),[]),"../public/assets/charts/阴游.json":()=>u(()=>import("./阴游-7f321caa.js"),[])}),`../public/assets/charts/${t}.json`).then(async a=>p=a.default),p==null)throw f.clear(),b("游戏加载错误，请尝试刷新",1600,900,"center",200,new n(200,200,200)),new Error("Data file has nothing or corrupted or not exist.");p.script&&await O(Object.assign({"./scripts/introduction.ts":()=>u(()=>import("./introduction-2a42a2cc.js"),["assets/introduction-2a42a2cc.js","assets/preload-helper-8235fac6.js","assets/dynamic-import-helper-be004503.js"]),"./scripts/timer.ts":()=>u(()=>import("./timer-178cc27e.js"),["assets/timer-178cc27e.js","assets/preload-helper-8235fac6.js","assets/dynamic-import-helper-be004503.js"])}),`./scripts/${p.script}.ts`),E=[];for(let a=0;a<16;a++)E.push(new Audio(J));if(p.bgsound?w=new Audio((await u(()=>import(`./sounds/${p.bgsound}`),[])).default):w=new Audio(K),/[\s\S]*(iPhone|iPad|iPod)[\s\S]*/.test(navigator.userAgent)){w.load();for(let a=0;a<16;a++)E[a].load()}await new Promise(a=>{let i=setInterval(()=>{E[0].readyState==HTMLMediaElement.HAVE_ENOUGH_DATA&&w.readyState==HTMLMediaElement.HAVE_ENOUGH_DATA&&(clearInterval(i),a(null))},10)}),w.volume=.5*j,E.forEach(a=>{a.volume=1*j}),ct(),f.clear();let r=setInterval(()=>{w.currentTime>0&&(clearInterval(r),c.emit("start",null))},1);w.play().catch(async a=>{alert("您未开启音频自动播放，请关闭弹窗后点击屏幕开始游戏。"),await new Promise(i=>{document.onclick=o=>{i(null),document.onclick=null}}),w.play()}),c.on("start",()=>{let a=setInterval(async function(){if(V){S=(Date.now()-I)/1e3-h;return}lt(),h=(Date.now()-I)/1e3-S,c.emit("tick",h),H.forEach(i=>{i.a==12&&h-i.aa>i.hi?(i.a=0,i.aa=0):Math.abs(i.h-h)<=1.5/d?i.ho&&(i.a=11,i.aa=h):i.hi!=null&&Math.abs(i.h-i.p.spd-i.hi-h)<=1.5/d&&(i.a=12,i.aa=h),G(i),z(i)}),_.forEach(i=>{ht(i)}),_.forEach(i=>{h-i.h>.16&&!i.a&&(i.a=-1,c.emit("miss",null)),G(i)}),_.forEach(i=>{z(i)}),nt(),h>=p.length&&(clearInterval(a),V=!0,location.replace(`./finish.html?i=${t}&c=${D}&t=${(y/L*1e5).toFixed(0)}&p=${v}&g=${P}&m=${U-v-P}`))},1e3/d)})}window.onload=pt;export{c as b,b as r};
